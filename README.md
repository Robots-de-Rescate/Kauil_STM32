Kauil_STM32
===================


This repository has the code for the V2 controller board of Kauil. It uses an STM32F3 microcontroller to interface the hardware peripherals to the Linux system on board of the robot.

Structure of the repository
--------------------------------
The repository is organized to optimize the collaboration amongst members of the team simultaneously and reduce the amount of conflicts, while also providing a more insightful organization of the code.

A brief description of the main files and folders that are found here is shown below:

<dl>
    <dt>README.md: </dt>
    <dd> This file.</dd>

    <dt>README.img:</dt>
    <dd> A folder containing all the images from this README.</dd>

    <dt>Source:</dt>
    <dd> This folder contains all the source code used to build the firmware for the board. Its structure is described in more detail in its own <a href="https://github.com/Robots-de-Rescate/Kauil_STM32/tree/master/Source">README</a>.</dd>

    <dt>*Output:</dt>
    <dd> This folder has all the files generated by the compiler and the linker in order to generate the hex file that will be downloaded to the microcrontroller by the st-link driver.</dd>

    <dt>KauilSTM32Firmware.uvproj:</dt>
    <dd> This file describes the project in general, is the main one that Keil will open, and is where paths to include files (\*.h) are stored as well as paths to the source files in the project (\*.c).</dd>

    <dt>*KauilSTM32Firmware.uvopt:</dt>
    <dd> Here is where Keil stores the configuration of the programmer and the debugger, this file will be generated automatically after configuring the debugger and closing that Keil's session.</dd>

    <dt>LinuxWorkspace</dt>
    <dd> This folder contains all files related to compiling and debugging the project on Linux, they are required by make and the Makefile provided, to be able to compile, link, and download code to the board.</dd>
</dl>

**\* Note :** These files and folders were added to the .gitignore file so they are not being version controlled, this was done to keep the repository clean, and they will be generated by Keil automatically.

Other generated files were omitted because they are automatically generated and do not store information relevant to the project like GUI or user preferences.

Setting up a development environment
-----------------------------------------------
This section describes the basic configuration that has to be made to start developing code for the project, either under Windows using Keil or with GNU make on Linux. Although some familiarity with Keil and the STM32F3 development environment is expected, it's not a requirement.

Note: Right now the default development plataform is Keil, so people using Linux should update the KauilSTM32Firmware.uvproj through windows as described [here][5] when adding new modules to the project, changes to existing code should not be a problem.
 
###Windows

- Install MDKARM Keil V4 from [here][1], use all the default configuration settings.
- Install the ST-Link driver that is located in:

        C:\Keil\ARM\STLink\USBDriver\ST-Link_V2_USBDriver.exe

- Connect the USB cable to the port marked with *USB ST-Link*, wait for windows to recognize it and follow any device installation instructions.
- Clone this repository somewhere in your computer, either by using Github's GUI or with the following command on the Git Shell:

        git clone https://github.com/Robots-de-Rescate/Kauil_STM32.git

- Open the file KauilSTM32Firmware.uvproj, Keil should launch automatically and create some files and folders.
- Go to "Target options" in the icon with a magic wand
![Target options](README.img/SetupWindows1.jpg)

- In the debug tab select "ST-Link Debugger":
![ST-Link Debugger](README.img/SetupWindows2.jpg)

- Click on the Settings button:
![Settings](README.img/SetupWindows3.jpg)

- Change the port to SW:
![SW](README.img/SetupWindows4.jpg)

- In the Flash Download tab click the add button:
![Flash Download](README.img/SetupWindows5.jpg)

- Select STM32F3xx Flash and click Add, then click the Ok button:
![STM32F3xx Flash](README.img/SetupWindows6.jpg)

- Finally on the Utilities tab select the ST-Link Debugger, then click Ok:
![ST-Link Debugger](README.img/SetupWindows7.jpg)

Now you should be able to build, download and debug the latest firmware on the STM32, by using the respective buttons on the main toolbar. The file KauilSTM32Firmware.uvopt should store the debugging configuration for the next time.

###Linux

The basic workspace setup for developing on Linux is composed of a compiler and a flashing utility that communicates to the stlink programmer embedded in the STM32F3 discovery board, as a compiler and build toolchain we will be using the ARM GCC toolchain, as a flashing utility we will use OpenOCD. Although this will be a pureley command line workspace and we think it's enough for development, a graphical IDE like Eclipse can be adapted to work with it as shown [here][3].

For a more detailed description of the basic workspace look in the [LinuxWorkspace][4] folder.

####Arm toolchain installation
This software can be installed from a PPA on launchpad, to get more detailed and updated information you can check it [here][2], the process will vary if you have Ubuntu 14.04.

For ubuntu 14.04 use:

       sudo apt-get remove binutils-arm-none-eabi gcc-arm-none-eabi
       sudo add-apt-repository ppa:terry.guo/gcc-arm-embedded
       sudo apt-get update
       sudo apt-get install gcc-arm-none-eabi=4.8.4.2014q3-0trusty10

For any version of Ubuntu before 14.04 use:

       sudo add-apt-repository ppa:terry.guo/gcc-arm-embedded
       sudo apt-get update
       sudo apt-get install gcc-arm-none-eabi

####OpenOCD installation
OpenOCD must be installed from source to enable stlink support, and it is also recommended because the version available in the repositories is very outdated. To do so follow the following steps.

Install the required dependencies:
       sudo apt-get install git zlib1g-dev libtool flex bison libgmp3-dev \
           libmpfr-dev libncurses5-dev libmpc-dev autoconf texinfo \
           build-essential libftdi-dev libusb-1.0.0-dev

Download the code for OpenOCD and open the folder:
       wget http://sourceforge.net/projects/openocd/files/openocd/0.8.0/openocd-0.8.0.zip/download -O ~/openocd-0.8.0.zip
       unzip ~/openocd-0.8.0.zip -d ~
       cd ~/openocd-0.8.0

Compile OpenOCD with support for stlink:
       ./configure --enable-maintainer-mode --enable-stlink
       make
       sudo make install

Add a udev rule to access stlink without sudo, creating the file /etc/udev/rules.d/99-stlink.rules (`sudo gedit /etc/udev/rules.d/99-stlink.rules`) with the following content:
       ATTRS{idVendor}=="0483", ATTRS{idProduct}=="3748", MODE="0666"

Then reload the rules to start using the one that was just created with `sudo udevadm control --reload-rules`.

After doing this, you should be able to clone this repository, cd into it on a terminal, and then use `make`, `make program`, and `make debug` to compile the code, flash the STM32F3 while connected via USB, and debug your code using GDB respectiveley.


 [1]: https://www.keil.com/demo/eval/armv4.htm
 [2]: https://launchpad.net/~terry.guo/+archive/ubuntu/gcc-arm-embedded
 [3]: http://engineering-diy.blogspot.mx/2012/11/stm32f3-discovery-eclipse-openocd.html
 [4]: https://github.com/Robots-de-Rescate/Kauil_STM32/tree/master/LinuxWorkspace
 [5]: https://github.com/Robots-de-Rescate/Kauil_STM32/tree/master/Source#adding-a-new-module
